# **Task3_Training**

1. <a href='#1'> iptables packet flow diagram
2. <a href='#2'> Use module TRACE to follow flow of packet
3. <a href='#3'> Read iptables rules to debug
4. <a href='#4'> tcpdumps and another options to debug network

****

<div id='1'></div>

## iptables packet flow diagram
- When a packet first enters the firewall, it hits the hardware and then gets passed on to the proper device driver in the kernel. Then the packet starts to go through a series of steps in the kernel, before it is either sent to the correct application (locally), or forwarded to another host - or whatever happens to it. 

![](src/ip_flow.png)

### Tables in iptables 

#### Raw tables:

![](src/raw.png)

- The raw table and its chains are used before any other tables in netfilter. It was introduced to use the NOTRACK target. This table is rather new and is only available, if compiled, with late 2.6 kernels and later. The raw table contains two chains. The PREROUTING and OUTPUT chain, where they will handle packets before they hit any of the other netfilter subsystems. The PREROUTING chain can be used for all incoming packets to this machine, or that are forwarded, while the OUTPUT chain can be used to alter the locally generated packets before they hit any of the other netfilter subsystems. 

#### Mangle tables: 

![](src/mangle.png)

This table is used to mangle (modify) packets. It is primarily used for changing these fields in a packet and is not to be used for filtering or any sort of NATing. It has the following actions/ targets:
- TOS (Type of Service)
- TTL (Time To Live)
- MARK 

This table has chains everywhere. You can mangle during:
- PREROUTING (as a packet enters the host): is used for altering packet just as they enter the firewall and before hit the routing decision. 
- OUTPUT (or for a packet generated by the host): is used for altering locally generated packets after they enter the routing decision.
- INPUT (a packet destined for this host): is used to alter packets after they have been routed to the local computer itself, but before the user space application actually sees the data.
- FORWARD (a packet being forwarded via this host: is used to mangle packets after they have hit the first routing decision, but before they actually hit the last routing decision
- POSTROUTING (as a packet leaves the host): is used to mangle packets just after all routing decisions have been made.

**Examples:**
```
## mark packets to port 22
iptables -t mangle -A PREROUTING -p tcp --dport 22 -j MARK --set-mark 2

## restore the packet's mark from that of the connection
iptables -A POSTROUTING -t mangle -j CONNMARK --restore-mark
 
## if the packet's mark is not 0 accept it
iptables -A POSTROUTING -t mangle -m mark ! --mark 0 -j ACCEPT
 
## once accepted, set a mark of 1 or 2 on the packet depending on the destination port
iptables -A POSTROUTING -p tcp --dport 21 -t mangle -j MARK --set-mark 1
iptables -A POSTROUTING -p tcp --dport 80 -t mangle -j MARK --set-mark 2
 
## now save this mark to the connection itself
iptables -A POSTROUTING -t mangle -j CONNMARK --save-mark
```

#### NAT tables

![](src/nat.png)

